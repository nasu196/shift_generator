# シフト作成システム要件定義

## 1. システム概要
   - **目的**: 効率的かつ公平性の高い勤務シフト表を自動生成する。
   - **対象ユーザー**: シフト管理者、施設長など。

## 2. 主要機能要件
   - **シフト作成機能**:
     - 指定された期間（開始日、週数など）のシフト表を自動生成する。
     - 施設全体のルールと従業員個人のルールを考慮する。
     - 過去の勤務実績を考慮する（オプション）。
     - 祝日情報を考慮する。
   - **従業員管理機能**:
     - 職員ID、氏名、担当フロア、役職、常勤/パート区分、勤務可能ステータス（育休、病休など）、他フロア応援可否などの情報を管理する。
   - **ルール管理機能**:
     - **施設ルール**:
       - 最低人員配置（フロア別、シフト別、日付種別[平日/休日/祝日/ALL]別）
       - 勤務シフトのシーケンス（例: 「夜勤」→「明」→「公」の必須化）
       - 連続勤務日数上限（全体、または従業員グループ別）
       - 総公休日数の最低日数（従業員グループ別、例: 常勤は月8日以上）
       - 特定シフトの均等割り当て（例: 夜勤回数、早出回数）
     - **個人ルール**:
       - 特定日の希望シフト/希望休（ハード制約/ソフト制約）
       - 連続勤務上限（個人別設定）
       - 特定曜日の希望シフト/希望休
       - 特定シフトの禁止
       - 勤務可能なシフト種別の限定（例: 「日勤」と「早出」のみ可）
       - 特定職員との同時勤務禁止
       - 一定期間内の総勤務日数/時間の上限・下限
       - 祝日の休み希望（優先度設定可能）
   - **出力機能**:
     - 生成されたシフト表をCSVファイル形式で出力する。
     - ルール違反やソフト制約のペナルティ状況などをログ出力する。

## 3. 非機能要件
   - **ユーザビリティ**: ルール設定や結果確認が直感的に行えること。
   - **パフォーマンス**: 大量の職員・長期間のシフト作成にも現実的な時間で対応できること。
   - **保守性**: ルールの追加・変更が容易であること。

## 4. 制約条件（詳細）
   （ここでは、現在の `input/facility_rules.txt` やこれまでのログで確認された具体的な制約を例として記述します）
   - **施設ルール例**:
     - `1Fは早出2名、日勤4名、夜勤2名が最低必須`
     - `2Fは早出3名、日勤5名、夜勤3名が最低必須`
     - `夜勤の翌日は必ず明け、明けの翌日は必ず公休とする` (ハード制約)
     - `常勤職員は期間中に最低8日の公休を確保する` (ハード制約)
     - `連続勤務は最大4日までとする` (ハード制約)
     - `夜勤、早出、明勤の回数は全職員で可能な限り均等にする` (ソフト制約)
   - **個人ルール例**:
     - `EMP001は2025-04-15に「公」を希望する` (ソフト制約)
     - `EMP037は「日勤」と「早出」以外の勤務は不可` (ハード制約)
     - `EMP007とEMP034は同時に「夜勤」に入らない` (ハード制約)
     - `EMP041は連続勤務3日まで` (ハード制約)

## 5. 入出力データ形式（案）
   - **入力**:
     - 従業員情報CSV (`input/employees.csv` 現行形式を踏襲)
     - 施設ルール定義ファイル (テキスト形式 or CSV/JSONなど構造化形式を検討)
     - 個人希望・ルール定義ファイル (CSV/JSONなど構造化形式を検討)
     - 祝日リスト
     - (オプション) 過去のシフト実績CSV
   - **出力**:
     - シフト表CSV (現行形式を踏襲しつつ、必要な情報を追加検討)
     - 実行ログ (制約充足状況、ペナルティ詳細など)

## 6. その他
   - 解析不能なルール (`UNPARSABLE`) の扱いを明確にする。
     - (例: エラーとして処理を中断する、無視して警告する、など) 

## 7. システムアーキテクチャ概要 (現状の理解に基づく)

システムの主要な処理は、以下のコンポーネントが連携して行われます。

   - **a. 生成AI (Large Language Model API)**:
     - **役割**: 生成AIは2段階の処理でルールの変換を行います。
       1.  **第1段階**: 自然言語で記述されたルール（施設ルール、個人ルール等）を、人間が確認しやすい中間的なテキスト形式（定型的な確認用テキスト）に翻訳します。
       2.  **第2段階**: 第1段階で生成された中間テキスト形式を、システムが処理しやすい構造化されたJSON形式のルールデータに変換します。
     - **入力**: （各段階で）ルールテキスト、事前定義されたプロンプト。
     - **出力**: （各段階で）中間テキスト表現、または構造化JSON形式のルールデータ。

   - **b. ルールパーサー (`rule_parser.py` に相当するモジュール)**:
     - **役割**: 生成AIが出力した構造化JSONルールデータを検証します。日付文字列をdateオブジェクトに正規化したり、データ型を検証・変換したりします。また、`PREFER_ALL_HOLIDAYS_OFF` のような抽象的なルールを、具体的な日付指定ルール（例: `SPECIFY_DATE_SHIFT`）に展開する処理も担います。最終的に、OR-Toolsモデルが直接利用できるPythonの辞書やオブジェクトのリスト形式に整形します。無効なルールやAIが解釈不能としたルールを識別し、ログに出力します。
     - **入力**: 生成AIからの構造化JSONルールデータ、シフト対象期間（開始日・終了日）、祝日リスト。
     - **出力**: 検証・整形済みのルール辞書/オブジェクトのリスト。

   - **c. OR-Toolsモデル構築・解決 (`shift_model.py` に相当するモジュール)**:
     - **役割**: ルールパーサーから受け取った整形済みルール、従業員情報、過去のシフト実績（オプション）、シフト対象期間、祝日情報などに基づき、OR-Tools (CP-SAT) の制約最適化モデルを構築します。この際、従業員ごとのシフト割り当て変数を定義し、各種ルールをハード制約またはソフト制約（ペナルティを伴う目的関数の一部）としてモデルに追加します。モデル構築後、ソルバーを実行して最適なシフト割り当てを探索し、結果を出力可能な形式に整形します。
     - **入力**: 整形済みルールリスト、従業員情報 (CSVなどから読み込み)、過去シフト情報（オプション）、シフト対象期間、祝日リスト。
     - **出力**: シフト割り当て結果（CSVファイルやログファイルとして出力される）、制約充足状況やペナルティに関するログ情報。

## 8. 主要機能の操作フロー例

   - **a. シフト作成フロー**:
     1.  **システム起動**: 管理者がシフト作成アプリケーション（またはスクリプト）を実行します。
     2.  **パラメータ設定**: 
         - シフト作成対象期間の開始日と、期間（例: 4週間）を指定します。
         - (オプション) 過去の勤務実績が記録されたCSVファイルのパスを指定します。
         - (オプション) 最新の祝日情報ファイル（またはAPIエンドポイント等）を指定、またはデフォルト設定を使用します。
     3.  **入力ファイルの準備**: 
         - `employees.csv` (従業員情報)
         - 施設ルールファイル (例: `facility_rules.txt`)
         - 個人ルールファイル (例: `personal_rules.json` またはCSV)
         - 上記ファイルが所定の場所にあることを確認します。
     4.  **シフト生成実行**: 管理者が「シフト生成開始」コマンド（またはボタン）を実行します。
     5.  **ルール解釈 (AI & パーサー)**: 
         - システムが施設ルールファイルと個人ルールファイルを読み込みます。
         - 生成AIコンポーネントが、各ルールテキストを構造化JSONデータに変換します。
         - ルールパーサーコンポーネントが、構造化JSONデータを検証・整形し、モデル用のルールリストを作成します。
         - この過程で、解釈不能なルールや無効なルールはログに出力されます。
     6.  **モデル構築と解決 (OR-Tools)**:
         - OR-Toolsモデル構築コンポーネントが、従業員情報、整形済みルールリスト、期間情報などを用いて制約最適化モデルを構築します。
         - ソルバーが実行され、最適なシフト割り当てが計算されます。
     7.  **結果出力**: 
         - 生成されたシフト表が指定された形式 (例: `results/shift_YYYYMMDD_vXX.csv`) で出力されます。
         - 実行ログ（処理の進捗、適用されたルール数、制約違反のペナルティ詳細など）が出力されます。
     8.  **結果確認**: 管理者が生成されたシフト表CSVファイルとログファイルを確認します。

   - **b. ルール管理フロー (例: 個人ルールの追加/編集 - GUIを想定)**:
     1.  **ルール管理画面起動**: 管理者がルール管理インターフェースを開きます。
     2.  **従業員選択**: ルールを設定したい従業員を選択します。
     3.  **ルール一覧表示**: 選択した従業員に既に設定されているルールの一覧が表示されます。
     4.  **ルール追加/編集**: 
         - 「新規ルール追加」ボタンをクリックするか、既存のルールを選択して編集を開始します。
         - ルールタイプ（例: `SPECIFY_DATE_SHIFT`, `MAX_CONSECUTIVE_WORK`など）をプルダウン等から選択します。
         - 選択したルールタイプに応じて、必要なパラメータ（日付、シフト記号、日数、ハード/ソフト制約の別など）を入力フォームに設定します。
         - (ソフト制約の場合) ペナルティの重みを設定します（オプション）。
     5.  **ルール保存**: 「保存」ボタンをクリックすると、入力されたルールが検証され、問題がなければシステム内の個人ルール定義ファイル（またはデータベース）に保存/更新されます。
     6.  次回シフト作成時から、保存/更新されたルールが反映されます。

   *(注: ルール管理フローは、現状のCUIベースのシステムでは直接的な操作フローと異なりますが、将来的なGUI化や設定ファイルの直接編集といった運用を想定したものです。)*

## 9. 使用技術スタック（案）

本システムの構築および運用において、以下の技術の使用を想定しています。

   - **プログラミング言語**:
     - Python (3.x): システム全体の開発言語。データ処理、OR-Tools連携、API連携などに使用。

   - **主要ライブラリ/フレームワーク**:
     - **OR-Tools (Google)**: シフトスケジューリング問題の解決（制約最適化モデリングとソルバー）。CP-SATソルバーを主に利用。
     - **Pandas**: CSVファイルの読み書き、データ集計、データ整形などの表形式データ操作。
     - **NumPy**: 数値計算（Pandasの内部依存としても利用）。
     - **Requests** (または同様のHTTPクライアントライブラリ): Gemini APIなどの外部APIとの連携用。

   - **大規模言語モデル (LLM)**:
     - **Gemini API (Google)**: 自然言語で記述されたルールの解釈、中間テキストへの翻訳、構造化データ (JSON) への変換。

   - **データ形式**:
     - **CSV**: 従業員情報、過去シフト実績、生成シフト表などの主要なデータ交換形式。
     - **JSON**: 生成AIとの連携における構造化ルールデータの中間形式、設定ファイルなどでの利用を想定。
     - **テキストファイル (.txt)**: 施設ルールなどの初期入力形式の一つとして。

   - **バージョン管理**:
     - **Git**: ソースコードのバージョン管理。
     - **GitHub/GitLab等**: リモートリポジトリおよび共同開発プラットフォーム（必要に応じて）。

   - **実行環境**:
     - ローカルPC環境（Python実行環境）。
     - (将来的には) Dockerコンテナによる環境分離や、クラウドプラットフォーム（Google Cloud, AWSなど）上での実行も検討可能。

   - **開発ツール**:
     - 統合開発環境 (IDE): Visual Studio Code, PyCharm など。
     - Jupyter Notebook/Lab: データ分析、プロトタイピング、実験的コーディング（必要に応じて）。

</rewritten_file> 